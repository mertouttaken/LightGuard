package com.mertout.lightguard.checks.impl;

import com.mertout.lightguard.checks.Check;
import com.mertout.lightguard.data.PlayerData;
import net.minecraft.server.v1_16_R3.*;

import java.lang.invoke.MethodHandles;
import java.lang.invoke.VarHandle;

public class EOFExploitCheck extends Check {

    private static final VarHandle WINDOW_ITEM;
    private static final VarHandle CREATIVE_ITEM;

    static {
        try {
            MethodHandles.Lookup lookup = MethodHandles.lookup();
            WINDOW_ITEM = MethodHandles.privateLookupIn(PacketPlayInWindowClick.class, lookup)
                    .findVarHandle(PacketPlayInWindowClick.class, "item", ItemStack.class);
            CREATIVE_ITEM = MethodHandles.privateLookupIn(PacketPlayInSetCreativeSlot.class, lookup)
                    .findVarHandle(PacketPlayInSetCreativeSlot.class, "b", ItemStack.class);
        } catch (Exception e) {
            throw new ExceptionInInitializerError(e);
        }
    }

    public EOFExploitCheck(PlayerData data) {
        super(data, "EOFExploit", "eof-exploit");
    }

    @Override
    public boolean check(Object packet) {
        if (!isEnabled()) return true;

        if (packet instanceof PacketPlayInSetCreativeSlot || packet instanceof PacketPlayInWindowClick) {
            try {
                ItemStack item = null;

                if (packet instanceof PacketPlayInSetCreativeSlot) {
                    item = (ItemStack) CREATIVE_ITEM.get(packet);
                } else {
                    item = (ItemStack) WINDOW_ITEM.get(packet);
                }

                if (item != null && item.hasTag()) {
                    NBTTagCompound tag = item.getTag();
                    String tagString = tag.toString();

                    if (tagString.contains("\u0000") || tagString.length() > 32767) {
                        flag("EOF Exploit NBT Detected", packet.getClass().getSimpleName());
                        return false;
                    }

                    int openBrackets = countOccurrences(tagString, '{');
                    int closeBrackets = countOccurrences(tagString, '}');

                    if (openBrackets != closeBrackets) {
                        flag("Malformed NBT Structure (Unbalanced Brackets)", packet.getClass().getSimpleName());
                        return false;
                    }
                }
            } catch (Exception e) {
            }
        }
        return true;
    }

    private int countOccurrences(String str, char c) {
        int count = 0;
        for (int i = 0; i < str.length(); i++) {
            if (str.charAt(i) == c) {
                count++;
            }
        }
        return count;
    }
}