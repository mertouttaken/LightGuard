package com.mertout.lightguard.checks.impl;

import com.mertout.lightguard.checks.Check;
import com.mertout.lightguard.data.PlayerData;
import net.minecraft.server.v1_16_R3.ItemStack;
import net.minecraft.server.v1_16_R3.Items;
import net.minecraft.server.v1_16_R3.PacketPlayInSetCreativeSlot;

import java.lang.reflect.Field;

public class MapExploitCheck extends Check {

    // Reflection Cache (Performans için)
    private static Field creativeItemField;

    static {
        try {
            // 1.16.5 NMS: PacketPlayInSetCreativeSlot içindeki item field'ı 'b'dir.
            creativeItemField = PacketPlayInSetCreativeSlot.class.getDeclaredField("b");
            creativeItemField.setAccessible(true);
        } catch (Exception e) {
            e.printStackTrace();
        }
    }

    // Rate Limiting değişkenleri (Oyuncuya özel)
    private long lastMapTime;
    private int mapCount;

    public MapExploitCheck(PlayerData data) {
        super(data, "MapExploit");
    }

    @Override
    public boolean check(Object packet) {
        // Config kontrolü
        if (!plugin.getConfig().getBoolean("checks.map-exploit.enabled")) return true;

        if (packet instanceof PacketPlayInSetCreativeSlot) {
            try {
                // Paketten itemi al
                ItemStack item = (ItemStack) creativeItemField.get(packet);

                // Boş değilse ve TİPİ HARİTA İSE
                if (item != null && item.getItem() == Items.FILLED_MAP) {

                    long now = System.currentTimeMillis();

                    // ➤ 1. RATE LIMIT (Saniyede kaç harita oluşturabilir?)
                    if (now - lastMapTime > 1000) {
                        mapCount = 0;
                        lastMapTime = now;
                    }

                    mapCount++;
                    int maxPPS = plugin.getConfig().getInt("checks.map-exploit.max-pps", 5);

                    if (mapCount > maxPPS) {
                        flag("Map Spam (Rate: " + mapCount + ")", "PacketPlayInSetCreativeSlot");
                        return false;
                    }

                    // ➤ 2. NBT SIZE LIMIT (Harita verisi çok mu büyük?)
                    if (item.hasTag()) {
                        String nbtString = item.getTag().toString();
                        int maxNbt = plugin.getConfig().getInt("checks.map-exploit.max-nbt-size", 8192); // 8KB

                        if (nbtString.length() > maxNbt) {
                            flag("Oversized Map NBT (" + nbtString.length() + " chars)", "PacketPlayInSetCreativeSlot");
                            return false;
                        }
                    }
                }
            } catch (Exception e) {
                // Reflection hatası olursa güvenli tarafta kalıp paketi engellemiyoruz
                // (Sentinel sistemi zaten kritik hataları yakalar)
            }
        }
        return true;
    }
}