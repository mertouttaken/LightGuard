package com.mertout.lightguard.checks.impl;

import com.mertout.lightguard.checks.Check;
import com.mertout.lightguard.data.PlayerData;
import net.minecraft.server.v1_16_R3.ItemStack;
import net.minecraft.server.v1_16_R3.Items;
import net.minecraft.server.v1_16_R3.PacketPlayInSetCreativeSlot;
import java.lang.invoke.MethodHandles;
import java.lang.invoke.VarHandle;
import java.util.concurrent.atomic.AtomicInteger;
import java.util.concurrent.atomic.AtomicLong;

public class MapExploitCheck extends Check {

    private static final VarHandle ITEM_FIELD;
    static {
        try {
            MethodHandles.Lookup lookup = MethodHandles.privateLookupIn(PacketPlayInSetCreativeSlot.class, MethodHandles.lookup());
            ITEM_FIELD = lookup.findVarHandle(PacketPlayInSetCreativeSlot.class, "b", ItemStack.class);
        } catch (Exception e) { throw new ExceptionInInitializerError(e); }
    }

    private final int maxPPS;
    private final int maxNbtSize;

    private final AtomicLong lastMapTime = new AtomicLong();
    private final AtomicInteger mapCount = new AtomicInteger();

    public MapExploitCheck(PlayerData data) {
        super(data, "MapExploit", "map-exploit");
        this.maxPPS = plugin.getConfig().getInt("checks.map-exploit.max-pps", 5);
        this.maxNbtSize = plugin.getConfig().getInt("checks.map-exploit.max-nbt-size", 8192);
    }

    @Override
    public boolean check(Object packet) {
        if (!isEnabled()) return true;
        if (packet instanceof PacketPlayInSetCreativeSlot) {
            ItemStack item = (ItemStack) ITEM_FIELD.get(packet);
            if (item != null && item.getItem() == Items.FILLED_MAP) {
                long now = System.currentTimeMillis();
                if (now - lastMapTime.get() > 1000) {
                    mapCount.set(0);
                    lastMapTime.set(now);
                }
                if (mapCount.incrementAndGet() > maxPPS) {
                    flag("Map Spam", "PacketPlayInSetCreativeSlot");
                    return false;
                }
                if (item.hasTag() && item.getTag().toString().length() > maxNbtSize) {
                    flag("Oversized Map NBT", "PacketPlayInSetCreativeSlot");
                    return false;
                }
            }
        }
        return true;
    }
}