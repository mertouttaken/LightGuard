package com.mertout.lightguard.checks.impl;

import com.mertout.lightguard.checks.Check;
import com.mertout.lightguard.data.PlayerData;
import com.mertout.lightguard.utils.NBTChecker;
import net.minecraft.server.v1_16_R3.*;
import java.lang.reflect.Field;

public class ItemExploitCheck extends Check {

    private static Field windowClickItemField;
    private static Field creativeSlotItemField;

    static {
        try {
            windowClickItemField = PacketPlayInWindowClick.class.getDeclaredField("item");
            windowClickItemField.setAccessible(true);
            creativeSlotItemField = PacketPlayInSetCreativeSlot.class.getDeclaredField("b");
            creativeSlotItemField.setAccessible(true);
        } catch (NoSuchFieldException e) { e.printStackTrace(); }
    }

    // Cache
    private final int maxDepth;
    private final int maxAttributes;
    private final double maxAttributeValue;

    public ItemExploitCheck(PlayerData data) {
        super(data, "ItemExploit", "item");
        this.maxDepth = plugin.getConfig().getInt("checks.nbt.max-depth", 15);
        this.maxAttributes = plugin.getConfig().getInt("checks.item.max-attributes", 15);
        this.maxAttributeValue = plugin.getConfig().getDouble("checks.item.max-attribute-value", 2048.0);
    }

    @Override
    public boolean check(Object packet) {
        if (!isEnabled()) return true;

        ItemStack nmsItem = null;
        try {
            if (packet instanceof PacketPlayInWindowClick) {
                nmsItem = (ItemStack) windowClickItemField.get(packet);
            } else if (packet instanceof PacketPlayInSetCreativeSlot) {
                nmsItem = (ItemStack) creativeSlotItemField.get(packet);
            }
        } catch (Exception e) {
            return false;
        }

        if (nmsItem != null && !nmsItem.isEmpty()) {
            if (!checkItem(nmsItem)) return false;
        }
        return true;
    }

    private boolean checkItem(ItemStack item) {
        if (item == null || !item.hasTag()) return true;
        NBTTagCompound tag = item.getTag();

        if (NBTChecker.isNBTDangerous(tag, maxDepth)) {
            flag("Malicious NBT Structure (Cycle/Depth)", "NBTExploit");
            return false;
        }
        if (!validateAttributes(tag)) return false;
        return true;
    }

    private boolean validateAttributes(NBTTagCompound tag) {
        if (tag.hasKeyOfType("AttributeModifiers", 9)) {
            NBTTagList attributes = tag.getList("AttributeModifiers", 10);
            if (attributes.size() > maxAttributes) {
                flag("Too many attributes (" + attributes.size() + ")", "AttributeLimiter");
                return false;
            }
            for (int i = 0; i < attributes.size(); i++) {
                NBTTagCompound attribute = attributes.getCompound(i);
                if (attribute.hasKeyOfType("Amount", 99)) {
                    double amount = attribute.getDouble("Amount");
                    if (!Double.isFinite(amount)) {
                        flag("Invalid Attribute Value (NaN/Infinity)", "AttributeLimiter");
                        return false;
                    }
                    if (Math.abs(amount) > maxAttributeValue) {
                        flag("Excessive Attribute Value (" + amount + ")", "AttributeLimiter");
                        return false;
                    }
                }
            }
        }
        return true;
    }
}