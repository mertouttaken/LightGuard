package com.mertout.lightguard.checks.impl;

import com.mertout.lightguard.checks.Check;
import com.mertout.lightguard.data.PlayerData;
import com.mertout.lightguard.utils.NBTChecker;
import net.minecraft.server.v1_16_R3.*;
import org.bukkit.GameMode;

import java.lang.invoke.MethodHandles;
import java.lang.invoke.VarHandle;
import java.util.List;

public class ItemExploitCheck extends Check {

    private static final VarHandle ITEM_FIELD;
    static {
        try {
            MethodHandles.Lookup lookup = MethodHandles.privateLookupIn(PacketPlayInSetCreativeSlot.class, MethodHandles.lookup());
            ITEM_FIELD = lookup.findVarHandle(PacketPlayInSetCreativeSlot.class, "b", ItemStack.class);
        } catch (Exception e) { throw new ExceptionInInitializerError(e); }
    }

    private final int maxLoreSize;
    private final int maxStringLen;
    private final int maxNbtDepth;
    private final int maxAttributes;
    private final double maxAttributeValue;
    private final List<String> illegalKeys;

    public ItemExploitCheck(PlayerData data) {
        super(data, "ItemExploit", "item-exploit");
        this.maxNbtDepth = plugin.getConfig().getInt("checks.item-exploit.max-depth", 7);
        this.maxAttributes = plugin.getConfig().getInt("checks.item-exploit.max-attributes", 7);
        this.maxAttributeValue = plugin.getConfig().getDouble("checks.item-exploit.max-attribute-value", 100.0);
        this.illegalKeys = plugin.getConfig().getStringList("checks.item-exploit.illegal-keys");

        this.maxLoreSize = plugin.getConfig().getInt("checks.item-exploit.max-lore-size", 10);
        this.maxStringLen = plugin.getConfig().getInt("checks.item-exploit.max-string-len", 100);
    }

    @Override
    public boolean check(Object packet) {
        if (!isEnabled()) return true;

        if (packet instanceof PacketPlayInSetCreativeSlot) {
            if (data.getGameMode() != GameMode.CREATIVE) {
                return false;
            }

            try {
                ItemStack item = (ItemStack) ITEM_FIELD.get(packet);
                if (item == null || item.isEmpty()) return true;

                if (item.hasTag()) {
                    NBTTagCompound tag = item.getTag();

                    if (NBTChecker.isNBTDangerous(tag, maxNbtDepth)) {
                        flag("Complex NBT Structure (Server Crash Attempt)", "CreativeSlot");
                        return false;
                    }

                    for (String key : illegalKeys) {
                        if (tag.hasKey(key)) {
                            flag("Illegal NBT Key Detected: " + key, "CreativeSlot");
                            return false;
                        }
                    }

                    if (isSemanticDangerous(tag)) {
                        flag("Malicious Item Data (Exploit Attempt)", "CreativeSlot");
                        return false;
                    }
                }

            } catch (Exception e) {
                return false;
            }
        }
        return true;
    }

    private boolean isSemanticDangerous(NBTTagCompound tag) {
        if (tag == null) return false;

        // --- ATTRIBUTE MODIFIERS ---
        if (tag.hasKeyOfType("AttributeModifiers", 9)) {
            NBTTagList attributes = tag.getList("AttributeModifiers", 10);
            if (attributes.size() > maxAttributes) return true;

            for (int i = 0; i < attributes.size(); i++) {
                NBTTagCompound attr = attributes.getCompound(i);
                if (attr.hasKeyOfType("Amount", 99)) {
                    double val = attr.getDouble("Amount");
                    if (Math.abs(val) > maxAttributeValue || !Double.isFinite(val)) return true;
                }
            }
        }

        // --- BANNER PATTERNS ---
        if (tag.hasKeyOfType("BlockEntityTag", 10)) {
            NBTTagCompound blockEntity = tag.getCompound("BlockEntityTag");
            if (blockEntity.hasKeyOfType("Patterns", 9)) {
                NBTTagList patterns = blockEntity.getList("Patterns", 10);
                if (patterns.size() > 20) return true;
            }
        }

        // --- FIREWORKS ---
        if (tag.hasKeyOfType("Fireworks", 10)) {
            NBTTagCompound fireworks = tag.getCompound("Fireworks");
            if (fireworks.hasKeyOfType("Explosions", 9)) {
                NBTTagList explosions = fireworks.getList("Explosions", 10);
                if (explosions.size() > 10) return true;
            }
        }

        // --- BOOKS (Pages) ---
        if (tag.hasKeyOfType("pages", 9)) {
            NBTTagList pages = tag.getList("pages", 8);
            if (pages.size() > 50) return true;

            for (int i = 0; i < pages.size(); i++) {
                String page = pages.getString(i);
                if (page.length() > 2000) return true;
                if (countChar(page, 'ยง') > 100) return true;
                if (isJsonBomb(page)) return true;
            }
        }

        // --- DISPLAY (Name & Lore) ---
        if (tag.hasKeyOfType("display", 10)) {
            NBTTagCompound display = tag.getCompound("display");

            if (display.hasKeyOfType("Name", 8)) {
                String name = display.getString("Name");
                if (name.length() > maxStringLen || isJsonBomb(name)) return true;
            }

            if (display.hasKeyOfType("Lore", 9)) {
                NBTTagList lore = display.getList("Lore", 8);
                if (lore.size() > maxLoreSize) return true;
                for (int i = 0; i < lore.size(); i++) {
                    String line = lore.getString(i);
                    if (line.length() > maxStringLen || isJsonBomb(line)) return true;
                }
            }
        }

        // --- SKULL TEXTURES ---
        if (tag.hasKeyOfType("SkullOwner", 10)) {
            NBTTagCompound owner = tag.getCompound("SkullOwner");
            if (owner.hasKeyOfType("Properties", 10)) {
                NBTTagCompound props = owner.getCompound("Properties");
                if (props.hasKeyOfType("textures", 9)) {
                    NBTTagList textures = props.getList("textures", 10);
                    for (int i = 0; i < textures.size(); i++) {
                        NBTTagCompound tex = textures.getCompound(i);
                        if (tex.hasKeyOfType("Value", 8)) {
                            if (tex.getString("Value").length() > 2000) return true;
                        }
                    }
                }
            }
        }

        return false;
    }

    private boolean isJsonBomb(String json) {
        if (json == null || json.length() < 10) return false;

        if (countMatches(json, "\"translate\"") > 5) return true;
        if (countMatches(json, "\"with\"") > 5) return true;
        if (countMatches(json, "\"extra\"") > 15) return true;
        if (countMatches(json, "\"score\"") > 5) return true;
        if (countMatches(json, "\"selector\"") > 5) return true;

        return false;
    }

    private int countMatches(String text, String target) {
        int count = 0;
        int idx = 0;
        while ((idx = text.indexOf(target, idx)) != -1) {
            count++;
            idx += target.length();
        }
        return count;
    }

    private int countChar(String str, char c) {
        int count = 0;
        for (int i = 0; i < str.length(); i++) {
            if (str.charAt(i) == c) count++;
        }
        return count;
    }
}