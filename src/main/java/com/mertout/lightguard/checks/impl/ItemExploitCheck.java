package com.mertout.lightguard.checks.impl;

import com.mertout.lightguard.checks.Check;
import com.mertout.lightguard.data.PlayerData;
import com.mertout.lightguard.utils.NBTChecker;
import net.minecraft.server.v1_16_R3.*;
import org.bukkit.GameMode;
import org.bukkit.Material;
import org.bukkit.craftbukkit.v1_16_R3.inventory.CraftItemStack;

import java.lang.reflect.Field;
import java.util.List;

public class ItemExploitCheck extends Check {

    public ItemExploitCheck(PlayerData data) {
        super(data, "ItemExploit");
    }

    @Override
    public boolean check(Object packet) {
        if (!plugin.getConfig().getBoolean("checks.item.enabled")) return true;

        // ➤ 1. Creative Slot Packet
        if (packet instanceof PacketPlayInSetCreativeSlot) {
            PacketPlayInSetCreativeSlot creativePacket = (PacketPlayInSetCreativeSlot) packet;
            ItemStack item = creativePacket.getItemStack(); // Creative paketinde bu metot çalışır

            // A) Survival Mode Check
            if (data.getPlayer().getGameMode() != GameMode.CREATIVE) {
                flag("Creative Packet in Survival Mode");
                data.getPlayer().updateInventory();
                return false;
            }

            // B) Item Analizi
            if (item != null && !item.isEmpty()) {
                if (!checkItem(item, "Creative")) return false;
            }
        }

        // ➤ 2. Window Click Packet (DÜZELTİLEN KISIM)
        if (packet instanceof PacketPlayInWindowClick) {
            PacketPlayInWindowClick click = (PacketPlayInWindowClick) packet;

            // HATA ÇÖZÜMÜ: click.e() short döner. Item'i Reflection ile alıyoruz.
            ItemStack item = getItemFromPacket(click);

            if (item != null && !item.isEmpty()) {
                if (!checkItem(item, "WindowClick")) return false;
            }
        }

        return true;
    }

    /**
     * PacketPlayInWindowClick içindeki 'item' field'ını okur.
     */
    private ItemStack getItemFromPacket(PacketPlayInWindowClick packet) {
        try {
            Field field = packet.getClass().getDeclaredField("item");
            field.setAccessible(true); // Private kilidini aç
            return (ItemStack) field.get(packet);
        } catch (Exception e) {
            return null; // Hata olursa null dön
        }
    }

    /**
     * İtemi NBT boyutu, yasaklı eşya listesi ve tehlikeli veriler açısından tarar.
     */
    private boolean checkItem(ItemStack item, String source) {
        // 1. Yasaklı Eşya Kontrolü (Creative Blacklist)
        if (source.equals("Creative")) {
            org.bukkit.inventory.ItemStack bukkitItem = CraftItemStack.asBukkitCopy(item);
            Material type = bukkitItem.getType();

            List<String> blacklist = plugin.getConfig().getStringList("checks.creative.blacklist");
            if (blacklist.contains(type.name())) {
                flag("Blacklisted Item: " + type.name());
                return false;
            }
        }

        // 2. NBT Kontrolleri
        if (item.hasTag()) {
            NBTTagCompound tag = item.getTag();
            String tagString = tag.toString();

            // A) NBT Boyut Limiti
            int maxSize = plugin.getConfig().getInt("checks.item.max-nbt-size", 5000);
            if (tagString.length() > maxSize) {
                flag("Oversized NBT Data (" + tagString.length() + " chars)");
                return false;
            }

            // B) Tehlikeli NBT Keys & Derinlik
            if (NBTChecker.isNBTDangerous(tag, plugin.getConfig())) {
                flag("Malicious NBT Structure");
                return false;
            }

            // C) Enchant Limit
            if (tag.hasKey("Enchantments")) {
                NBTTagList enchants = tag.getList("Enchantments", 10);
                if (enchants.size() > 20) {
                    flag("Too Many Enchantments");
                    return false;
                }
            }
            if (tag.hasKey("Potion") || tag.hasKey("CustomPotionEffects")) {
                if (tag.hasKey("CustomPotionEffects")) {
                    NBTTagList effects = tag.getList("CustomPotionEffects", 10);
                    if (effects.size() > 5) { // Max 5 efekt
                        flag("Too Many Potion Effects");
                        return false;
                    }
                    for (int i = 0; i < effects.size(); i++) {
                        NBTTagCompound effect = effects.getCompound(i);
                        if (effect.getByte("Amplifier") > 5) { // Max Level 5
                            flag("Invalid Potion Amplifier");
                            return false;
                        }
                    }
                }
            }

            if (tag.hasKey("BlockEntityTag")) {
                NBTTagCompound blockTag = tag.getCompound("BlockEntityTag");
                if (blockTag.hasKey("Patterns")) { // Banner Patterns
                    NBTTagList patterns = blockTag.getList("Patterns", 10);
                    if (patterns.size() > 20) { // Max 20 desen
                        flag("Too Many Banner Patterns");
                        return false;
                    }
                }
            }
        }

        return true;
    }
}