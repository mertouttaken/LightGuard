package com.mertout.lightguard.checks.impl;

import com.mertout.lightguard.checks.Check;
import com.mertout.lightguard.data.PlayerData;
import com.mertout.lightguard.utils.NBTChecker;
import net.minecraft.server.v1_16_R3.*;
import org.bukkit.Bukkit;
import org.bukkit.GameMode;
import org.bukkit.Material;
import org.bukkit.craftbukkit.v1_16_R3.inventory.CraftItemStack;
import org.bukkit.inventory.ItemStack;
import org.bukkit.inventory.meta.BookMeta;
import org.bukkit.inventory.meta.MapMeta;

import java.lang.reflect.Field;
import java.util.List;

public class ItemExploitCheck extends Check {

    public ItemExploitCheck(PlayerData data) {
        super(data, "ItemExploit");
    }

    @Override
    public boolean check(Object packet) {
        if (!plugin.getConfig().getBoolean("checks.item.enabled")) return true;

        // ➤ 1. Creative Slot Packet (C10)
        // Hileciler Creative modda olmasalar bile bu paketi yollayabilir.
        if (packet instanceof PacketPlayInSetCreativeSlot) {
            String packetName = "PacketPlayInSetCreativeSlot";
            PacketPlayInSetCreativeSlot creativePacket = (PacketPlayInSetCreativeSlot) packet;

            // A) Survival Mode Check (Kesin Engel)
            if (data.getPlayer().getGameMode() != GameMode.CREATIVE) {
                flag("Creative Packet in Survival Mode", packetName);
                // Envanteri düzelt ki hayalet item kalmasın
                Bukkit.getScheduler().runTask(plugin, () -> data.getPlayer().updateInventory());
                return false;
            }

            // B) Item Analizi
            net.minecraft.server.v1_16_R3.ItemStack nmsItem = creativePacket.getItemStack();
            if (nmsItem != null && !nmsItem.isEmpty()) {
                if (!checkItem(nmsItem, "Creative", packetName)) return false;
            }
        }

        // ➤ 2. Window Click Packet (C0E)
        if (packet instanceof PacketPlayInWindowClick) {
            String packetName = "PacketPlayInWindowClick";
            PacketPlayInWindowClick click = (PacketPlayInWindowClick) packet;

            // Reflection ile item'i al (Güvenli Yöntem)
            net.minecraft.server.v1_16_R3.ItemStack nmsItem = getItemFromWindowClick(click);

            if (nmsItem != null && !nmsItem.isEmpty()) {
                if (!checkItem(nmsItem, "WindowClick", packetName)) return false;
            }
        }

        // ➤ 3. Block Place Packet (C08) (Tengu/Book-BlockPlace Fix)
        // Bu paketlerde oyuncunun elindeki kitap sunucuya gönderilir.
        // Aslında eldeki item zaten daha önce kontrol edilmiştir ama
        // paket manipülasyonu ile (Packet Buffer) oynanmışsa NBTChecker burada da çalışmalı.
        if (packet instanceof PacketPlayInBlockPlace) {
            // 1.16'da eldeki itemi oyuncu envanterinden alıp kontrol edebiliriz
            // Ancak performans için burada tekrar NBT taraması yapmıyoruz.
            // Zaten Creative Slot veya Window Click ile o itemi alırken yakalamış olmalıyız.
        }

        return true;
    }

    /**
     * İtemi; NBT boyutu, yasaklı eşya listesi, Harita ve Kitap açıkları açısından tarar.
     */
    private boolean checkItem(net.minecraft.server.v1_16_R3.ItemStack nmsItem, String source, String packetName) {
        // Bukkit ItemStack çevirimi (Meta kontrolleri için daha kolay)
        ItemStack bukkitItem = CraftItemStack.asBukkitCopy(nmsItem);
        Material type = bukkitItem.getType();

        // 1. Yasaklı Eşya Kontrolü (Sadece Creative'de)
        if (source.equals("Creative")) {
            List<String> blacklist = plugin.getConfig().getStringList("checks.item.illegal-blocks");
            if (blacklist.contains(type.name())) {
                flag("Blacklisted Item: " + type.name(), packetName);
                return false;
            }
        }

        // 2. NBT (Tag) Kontrolleri
        if (nmsItem.hasTag()) {
            NBTTagCompound tag = nmsItem.getTag();
            String tagString = tag.toString();

            // A) NBT Boyut Limiti (Genel Crash)
            int maxSize = plugin.getConfig().getInt("checks.item.max-nbt-size", 4000);
            if (tagString.length() > maxSize) {
                flag("Oversized NBT Data (" + tagString.length() + " chars)", packetName);
                return false;
            }

            // B) Tehlikeli NBT Keys & Derinlik (NBTChecker)
            // Recursive NBT, JSON Bomb, NaN Attribute gibi şeyleri burası tutar.
            if (NBTChecker.isNBTDangerous(tag, plugin.getConfig())) {
                flag("Malicious NBT Structure", packetName);
                return false;
            }

            if (type == Material.FILLED_MAP) {
                if (bukkitItem.hasItemMeta() && bukkitItem.getItemMeta() instanceof MapMeta) {
                    MapMeta mapMeta = (MapMeta) bukkitItem.getItemMeta();
                    if (mapMeta.hasMapId()) {
                        int mapId = mapMeta.getMapId();

                        int safeLimit = 32767; // Güvenli sınır

                        if (mapId < 0 || mapId > safeLimit) {
                            flag("Invalid Map ID: " + mapId, packetName);
                            return false;
                        }
                    }
                }
            }

            // D) SpigotGuard Özelliği: Book (Kitap) Page Limit
            if (type == Material.WRITABLE_BOOK || type == Material.WRITTEN_BOOK) {
                if (bukkitItem.hasItemMeta() && bukkitItem.getItemMeta() instanceof BookMeta) {
                    BookMeta bookMeta = (BookMeta) bukkitItem.getItemMeta();
                    // Config'deki sayfa limiti (Örn: 5)
                    int maxPages = plugin.getConfig().getInt("checks.book.max-pages", 5);
                    if (bookMeta.getPageCount() > maxPages) {
                        flag("Too Many Book Pages (" + bookMeta.getPageCount() + ")", packetName);
                        return false;
                    }
                }
            }

            // E) Enchantment Limit
            if (tag.hasKey("Enchantments")) {
                NBTTagList enchants = tag.getList("Enchantments", 10);
                if (enchants.size() > 20) {
                    flag("Too Many Enchantments", packetName);
                    return false;
                }
            }

            // F) Potion Limit
            if (tag.hasKey("CustomPotionEffects")) {
                NBTTagList effects = tag.getList("CustomPotionEffects", 10);
                if (effects.size() > 10) {
                    flag("Too Many Potion Effects", packetName);
                    return false;
                }
                for (int i = 0; i < effects.size(); i++) {
                    NBTTagCompound effect = effects.getCompound(i);
                    // Amplifier (Seviye) kontrolü: 127'den büyükse (byte max) crash olabilir
                    if (effect.hasKey("Amplifier") && effect.getByte("Amplifier") < 0) {
                        flag("Invalid Potion Amplifier", packetName);
                        return false;
                    }
                }
            }
        }

        return true;
    }

    /**
     * PacketPlayInWindowClick içindeki 'item' field'ını okur.
     * Obfuscation değişimine karşı çoklu deneme yapar.
     */
    private net.minecraft.server.v1_16_R3.ItemStack getItemFromWindowClick(PacketPlayInWindowClick packet) {
        // 1. Deneme: "item" (Mapped/Deobfuscated isim)
        try {
            Field f = packet.getClass().getDeclaredField("item");
            f.setAccessible(true);
            return (net.minecraft.server.v1_16_R3.ItemStack) f.get(packet);
        } catch (Exception e1) {
            // 2. Deneme: "e" (Yaygın 1.16.5 Obfuscated isim)
            try {
                Field f = packet.getClass().getDeclaredField("e");
                f.setAccessible(true);
                return (net.minecraft.server.v1_16_R3.ItemStack) f.get(packet);
            } catch (Exception e2) {
                // 3. Deneme: "f" (Bazı varyasyonlarda)
                try {
                    Field f = packet.getClass().getDeclaredField("f");
                    f.setAccessible(true);
                    return (net.minecraft.server.v1_16_R3.ItemStack) f.get(packet);
                } catch (Exception e3) {
                    return null; // Hiçbiri tutmadı
                }
            }
        }
    }
}