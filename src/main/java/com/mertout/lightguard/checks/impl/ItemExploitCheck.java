package com.mertout.lightguard.checks.impl;

import com.mertout.lightguard.checks.Check;
import com.mertout.lightguard.data.PlayerData;
import com.mertout.lightguard.utils.NBTChecker;
import net.minecraft.server.v1_16_R3.*;

import java.lang.invoke.MethodHandles;
import java.lang.invoke.VarHandle;

public class ItemExploitCheck extends Check {

    private static final VarHandle ITEM_FIELD;
    static {
        try {
            MethodHandles.Lookup lookup = MethodHandles.privateLookupIn(PacketPlayInSetCreativeSlot.class, MethodHandles.lookup());
            ITEM_FIELD = lookup.findVarHandle(PacketPlayInSetCreativeSlot.class, "b", ItemStack.class);
        } catch (Exception e) { throw new ExceptionInInitializerError(e); }
    }

    private final int maxNbtDepth;

    public ItemExploitCheck(PlayerData data) {
        super(data, "ItemExploit", "item-exploit");
        this.maxNbtDepth = plugin.getConfig().getInt("checks.item-exploit.max-depth", 15);
    }

    @Override
    public boolean check(Object packet) {
        if (!isEnabled()) return true;

        if (packet instanceof PacketPlayInSetCreativeSlot) {
            if (!data.getPlayer().getGameMode().name().equals("CREATIVE")) {
                return false;
            }

            try {
                ItemStack item = (ItemStack) ITEM_FIELD.get(packet);
                if (item == null || item.isEmpty()) return true;

                if (item.hasTag()) {
                    if (NBTChecker.isNBTDangerous(item.getTag(), maxNbtDepth)) {
                        flag("Complex NBT Structure (Server Crash Attempt)", "CreativeSlot");
                        return false;
                    }

                    if (isSemanticDangerous(item.getTag())) {
                        flag("Malicious Item Data (Client Lag Attempt)", "CreativeSlot");
                        return false;
                    }
                }

            } catch (Exception e) {
                return false;
            }
        }
        return true;
    }

    private boolean isSemanticDangerous(NBTTagCompound tag) {
        if (tag == null) return false;

        if (tag.hasKeyOfType("BlockEntityTag", 10)) {
            NBTTagCompound blockEntity = tag.getCompound("BlockEntityTag");
            if (blockEntity.hasKeyOfType("Patterns", 9)) {
                NBTTagList patterns = blockEntity.getList("Patterns", 10);
                if (patterns.size() > 20) return true;
            }
        }

        if (tag.hasKeyOfType("Fireworks", 10)) {
            NBTTagCompound fireworks = tag.getCompound("Fireworks");
            if (fireworks.hasKeyOfType("Explosions", 9)) {
                NBTTagList explosions = fireworks.getList("Explosions", 10);
                if (explosions.size() > 10) return true;
            }
        }

        if (tag.hasKeyOfType("pages", 9)) {
            NBTTagList pages = tag.getList("pages", 8);
            if (pages.size() > 50) return true;

            for (int i = 0; i < pages.size(); i++) {
                String page = pages.getString(i);
                if (page.length() > 2000) return true;
                if (countChar(page, 'ยง') > 100) return true;

                if (isJsonBomb(page)) return true;
            }
        }

        if (tag.hasKeyOfType("display", 10)) {
            NBTTagCompound display = tag.getCompound("display");

            if (display.hasKeyOfType("Name", 8)) {
                String name = display.getString("Name");
                if (name.length() > 512) return true;
                if (isJsonBomb(name)) return true;
            }

            if (display.hasKeyOfType("Lore", 9)) {
                NBTTagList lore = display.getList("Lore", 8);
                if (lore.size() > 50) return true;
                for (int i = 0; i < lore.size(); i++) {
                    String line = lore.getString(i);
                    if (line.length() > 512) return true;
                    if (isJsonBomb(line)) return true;
                }
            }
        }

        // 5. Skulls
        if (tag.hasKeyOfType("SkullOwner", 10)) {
            NBTTagCompound owner = tag.getCompound("SkullOwner");
            if (owner.hasKeyOfType("Properties", 10)) {
                NBTTagCompound props = owner.getCompound("Properties");
                if (props.hasKeyOfType("textures", 9)) {
                    NBTTagList textures = props.getList("textures", 10);
                    for (int i = 0; i < textures.size(); i++) {
                        NBTTagCompound tex = textures.getCompound(i);
                        if (tex.hasKeyOfType("Value", 8)) {
                            if (tex.getString("Value").length() > 2000) return true;
                        }
                    }
                }
            }
        }

        return false;
    }

    private boolean isJsonBomb(String json) {
        if (json == null || json.length() < 10) return false;

        if (countMatches(json, "\"translate\"") > 5) return true;
        if (countMatches(json, "\"with\"") > 5) return true;
        if (countMatches(json, "\"extra\"") > 15) return true;
        if (countMatches(json, "\"score\"") > 5) return true; // Scoreboard exploit
        if (countMatches(json, "\"selector\"") > 5) return true; // Selector exploit (@e)

        return false;
    }

    private int countMatches(String text, String target) {
        int count = 0;
        int idx = 0;
        while ((idx = text.indexOf(target, idx)) != -1) {
            count++;
            idx += target.length();
        }
        return count;
    }

    private int countChar(String str, char c) {
        int count = 0;
        for (int i = 0; i < str.length(); i++) {
            if (str.charAt(i) == c) count++;
        }
        return count;
    }
}