package com.mertout.lightguard.checks.impl;

import com.mertout.lightguard.checks.Check;
import com.mertout.lightguard.data.PlayerData;
import com.mertout.lightguard.utils.NBTChecker;
import net.minecraft.server.v1_16_R3.*;
import java.lang.invoke.MethodHandles;
import java.lang.invoke.VarHandle;

public class ItemExploitCheck extends Check {

    private static final VarHandle WINDOW_ITEM;
    private static final VarHandle CREATIVE_ITEM;

    static {
        try {
            MethodHandles.Lookup lookup = MethodHandles.lookup();
            WINDOW_ITEM = MethodHandles.privateLookupIn(PacketPlayInWindowClick.class, lookup).findVarHandle(PacketPlayInWindowClick.class, "item", ItemStack.class);
            CREATIVE_ITEM = MethodHandles.privateLookupIn(PacketPlayInSetCreativeSlot.class, lookup).findVarHandle(PacketPlayInSetCreativeSlot.class, "b", ItemStack.class);
        } catch (Exception e) { throw new ExceptionInInitializerError(e); }
    }

    private final int maxDepth;
    private final int maxAttributes;
    private final double maxAttributeValue;

    public ItemExploitCheck(PlayerData data) {
        super(data, "ItemExploit", "item");
        this.maxDepth = plugin.getConfig().getInt("checks.item.max-depth", 15);
        this.maxAttributes = plugin.getConfig().getInt("checks.item.max-attributes", 15);
        this.maxAttributeValue = plugin.getConfig().getDouble("checks.item.max-attribute-value", 2048.0);
    }

    @Override
    public boolean check(Object packet) {
        if (!isEnabled()) return true;
        ItemStack nmsItem = null;
        if (packet instanceof PacketPlayInWindowClick) {
            nmsItem = (ItemStack) WINDOW_ITEM.get(packet);
        } else if (packet instanceof PacketPlayInSetCreativeSlot) {
            nmsItem = (ItemStack) CREATIVE_ITEM.get(packet);
        }

        if (nmsItem != null && !nmsItem.isEmpty()) {
            if (!validateItemStack(nmsItem)) return false;
            if (!checkItem(nmsItem)) return false;
        }
        return true;
    }

    private boolean validateItemStack(ItemStack item) {
        if (item.getCount() > 64 || item.getCount() < 0) {
            flag("Invalid count (" + item.getCount() + ")", "ItemStack");
            return false;
        }
        return true;
    }

    private boolean checkItem(ItemStack item) {
        if (!item.hasTag()) return true;
        NBTTagCompound tag = item.getTag();
        if (NBTChecker.isNBTDangerous(tag, maxDepth)) {
            flag("Malicious NBT", "NBTExploit");
            return false;
        }
        return true;
    }
}