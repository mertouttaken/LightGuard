package com.mertout.lightguard.checks.impl;

import com.mertout.lightguard.checks.Check;
import com.mertout.lightguard.data.PlayerData;
import com.mertout.lightguard.utils.NBTChecker; // NBTChecker importu
import net.minecraft.server.v1_16_R3.*;

import java.lang.reflect.Field;

public class ItemExploitCheck extends Check {

    // Reflection Field Cache (Performans için)
    private static Field windowClickItemField;
    private static Field creativeSlotItemField;

    static {
        try {
            // PacketPlayInWindowClick içindeki 'item' field'ı
            windowClickItemField = PacketPlayInWindowClick.class.getDeclaredField("item");
            windowClickItemField.setAccessible(true);

            // PacketPlayInSetCreativeSlot içindeki 'b' (item) field'ı (1.16.5 NMS mapping)
            creativeSlotItemField = PacketPlayInSetCreativeSlot.class.getDeclaredField("b");
            creativeSlotItemField.setAccessible(true);
        } catch (NoSuchFieldException e) {
            e.printStackTrace();
        }
    }

    public ItemExploitCheck(PlayerData data) {
        super(data, "ItemExploit");
    }

    @Override
    public boolean check(Object packet) {
        if (!plugin.getConfig().getBoolean("checks.item.enabled")) return true;

        ItemStack nmsItem = null;

        // --- 1. PAKET TİPİNE GÖRE ITEM ÇIKARMA (FAIL-CLOSED) ---
        try {
            if (packet instanceof PacketPlayInWindowClick) {
                // WindowClick paketinden item alma
                nmsItem = (ItemStack) windowClickItemField.get(packet);
            }
            else if (packet instanceof PacketPlayInSetCreativeSlot) {
                // CreativeSlot paketinden item alma
                nmsItem = (ItemStack) creativeSlotItemField.get(packet);
            }
        } catch (Exception e) {
            // FAIL-CLOSED: Reflection hatası olursa güvenliği sağlamak için paketi iptal et.
            plugin.getLogger().warning("Security Error: Failed to read item packet from " + data.getPlayer().getName());
            return false;
        }

        // Eğer paket içinde bir eşya varsa, onu kontrol et
        if (nmsItem != null && !nmsItem.isEmpty()) {
            if (!checkItem(nmsItem)) {
                return false; // Zararlı eşya tespit edildi, paketi iptal et
            }
        }

        return true;
    }

    /**
     * Eşya üzerinde tüm güvenlik kontrollerini çalıştırır.
     * @param item Kontrol edilecek NMS ItemStack
     * @return true ise güvenli, false ise zararlı
     */
    private boolean checkItem(ItemStack item) {
        if (item == null || !item.hasTag()) return true;

        NBTTagCompound tag = item.getTag();

        // ➤ 1. NBT CYCLIC & DEPTH CHECK (StackOverflow Koruması)
        // Config'den derinlik limitini alıyoruz (Default: 15)
        int maxDepth = plugin.getConfig().getInt("checks.nbt.max-depth", 15);

        // NBTChecker yardımcı sınıfını kullanıyoruz
        if (NBTChecker.isNBTDangerous(tag, maxDepth)) {
            flag("Malicious NBT Structure (Cycle/Depth)", "NBTExploit");
            return false;
        }

        // ➤ 2. ATTRIBUTE MODIFIER LIMITER (TPS Drop & GodMode Koruması)
        if (!validateAttributes(tag)) {
            return false;
        }

        // ➤ 3. EXTRA CHECKS (Örn: Kitap Sayfa Limiti vb. buraya eklenebilir)
        // if (!validateBook(tag)) return false;

        return true;
    }

    /**
     * Eşyanın Attribute Modifier'larını kontrol eder.
     */
    private boolean validateAttributes(NBTTagCompound tag) {
        // "AttributeModifiers" etiketi var mı? (ID 9 = List)
        if (tag.hasKeyOfType("AttributeModifiers", 9)) {

            // 1.16.5'te Liste tipi 10 (Compound) olmalıdır.
            NBTTagList attributes = tag.getList("AttributeModifiers", 10);

            // A. SAYI LİMİTİ KONTROLÜ
            int maxAttributes = plugin.getConfig().getInt("checks.item.max-attributes", 15);
            if (attributes.size() > maxAttributes) {
                flag("Too many attributes (" + attributes.size() + ")", "AttributeLimiter");
                return false;
            }

            // B. DEĞER LİMİTİ KONTROLÜ
            double maxValue = plugin.getConfig().getDouble("checks.item.max-attribute-value", 2048.0);

            for (int i = 0; i < attributes.size(); i++) {
                NBTTagCompound attribute = attributes.getCompound(i);

                // "Amount" değeri attribute'un gücüdür
                if (attribute.hasKeyOfType("Amount", 99)) { // 99 = Any Number
                    double amount = attribute.getDouble("Amount");

                    // Sonsuzluk veya NaN kontrolü (Java matematiğini bozar)
                    if (!Double.isFinite(amount)) {
                        flag("Invalid Attribute Value (NaN/Infinity)", "AttributeLimiter");
                        return false;
                    }

                    // Mutlak değer kontrolü (Negatif büyük sayılar da tehlikelidir)
                    if (Math.abs(amount) > maxValue) {
                        flag("Excessive Attribute Value (" + amount + ")", "AttributeLimiter");
                        return false;
                    }
                }
            }
        }
        return true;
    }
}