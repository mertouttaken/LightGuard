package com.mertout.lightguard.checks.impl;

import com.mertout.lightguard.checks.Check;
import com.mertout.lightguard.data.PlayerData;
import net.minecraft.server.v1_16_R3.*;
import java.lang.invoke.MethodHandles;
import java.lang.invoke.VarHandle;

public class BookExploitCheck extends Check {

    private static final VarHandle ITEM_FIELD;
    static {
        try {
            MethodHandles.Lookup lookup = MethodHandles.privateLookupIn(PacketPlayInBEdit.class, MethodHandles.lookup());
            ITEM_FIELD = lookup.findVarHandle(PacketPlayInBEdit.class, "a", ItemStack.class);
        } catch (Exception e) { throw new ExceptionInInitializerError(e); }
    }

    private final int maxPageLength;
    private final int maxPages;

    public BookExploitCheck(PlayerData data) {
        super(data, "BookExploit", "book");
        this.maxPageLength = plugin.getConfig().getInt("checks.book.max-bytes-per-page", 200);
        this.maxPages = plugin.getConfig().getInt("checks.book.max-pages", 5);
    }

    @Override
    public boolean check(Object packet) {
        if (!isEnabled()) return true;
        if (packet instanceof PacketPlayInBEdit) {
            ItemStack item = (ItemStack) ITEM_FIELD.get(packet);
            if (item != null && item.hasTag()) {
                NBTTagCompound tag = item.getTag();
                if (tag.hasKey("resolved")) {
                    flag("Illegal Book Tag (Resolved)", "PacketPlayInBEdit");
                    return false;
                }
                if (tag.hasKey("generation") && tag.getInt("generation") > 2) {
                    flag("Invalid Book Generation", "PacketPlayInBEdit");
                    return false;
                }
                if (tag.hasKey("pages")) {
                    NBTTagList pages = tag.getList("pages", 8);
                    if (pages.size() > maxPages) {
                        flag("Too many pages (" + pages.size() + ")", "PacketPlayInBEdit");
                        return false;
                    }
                    for (int i = 0; i < pages.size(); i++) {
                        String pageContent = pages.getString(i);
                        if (pageContent.length() > maxPageLength) {
                            flag("Page too long", "PacketPlayInBEdit");
                            return false;
                        }
                    }
                }
            }
        }
        return true;
    }
}