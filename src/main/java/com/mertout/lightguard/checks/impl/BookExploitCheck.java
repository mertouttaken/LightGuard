package com.mertout.lightguard.checks.impl;

import com.mertout.lightguard.checks.Check;
import com.mertout.lightguard.data.PlayerData;
import net.minecraft.server.v1_16_R3.*;

import java.lang.reflect.Field;

public class BookExploitCheck extends Check {

    public BookExploitCheck(PlayerData data) {
        super(data, "BookExploit");
    }

    @Override
    public boolean check(Object packet) {

        if (packet instanceof PacketPlayInBEdit) {
            ItemStack item = getItemField(packet, "a"); // Reflection helper metodunu kullan

            if (item != null && item.hasTag()) {
                NBTTagCompound tag = item.getTag();
                if (tag.hasKey("pages")) {
                    NBTTagList pages = tag.getList("pages", 8); // 8 = String List

                    for (int i = 0; i < pages.size(); i++) {
                        String pageContent = pages.getString(i);

                        // ➤ 1. Uzunluk Kontrolü
                        if (pageContent.length() > 2000) {
                            flag("Page too long", "BookExploit");
                            return false;
                        }

                        // ➤ 2. JSON Complexity (Bomb) Kontrolü
                        // Çok fazla iç içe parantez sunucunun JSON parser'ını kilitler.
                        if (getCharCount(pageContent, '{') > 50 || getCharCount(pageContent, '[') > 50) {
                            flag("Complex JSON detected", "BookExploit");
                            return false;
                        }
                    }
                }
            }
        }
        return true;
    }

    private int getCharCount(String s, char c) {
        int count = 0;
        for (int i = 0; i < s.length(); i++) {
            if (s.charAt(i) == c) count++;
        }
        return count;
    }

    private ItemStack getItemField(Object obj, String name) {
        try {
            Field f = obj.getClass().getDeclaredField(name);
            f.setAccessible(true);
            return (ItemStack) f.get(obj);
        } catch (Exception e) { return null; }
    }
}