package com.mertout.lightguard.checks.impl;

import com.mertout.lightguard.checks.Check;
import com.mertout.lightguard.data.PlayerData;
import net.minecraft.server.v1_16_R3.*;
import java.lang.reflect.Field;

public class BookExploitCheck extends Check {

    private final int maxPageLength;
    private final int maxPages;

    public BookExploitCheck(PlayerData data) {
        super(data, "BookExploit", "book");
        this.maxPageLength = plugin.getConfig().getInt("checks.book.max-bytes-per-page", 200);
        this.maxPages = plugin.getConfig().getInt("checks.book.max-pages", 5);
    }

    @Override
    public boolean check(Object packet) {
        if (!isEnabled()) return true;

        if (packet instanceof PacketPlayInBEdit) {
            ItemStack item = getItemField(packet, "a");

            if (item != null && item.hasTag()) {
                NBTTagCompound tag = item.getTag();

                if (tag.hasKey("resolved")) {
                    flag("Illegal Book Tag (Resolved)", "PacketPlayInBEdit");
                    return false;
                }

                if (tag.hasKey("generation") && tag.getInt("generation") > 2) {
                    flag("Invalid Book Generation", "PacketPlayInBEdit");
                    return false;
                }

                if (tag.hasKey("pages")) {
                    NBTTagList pages = tag.getList("pages", 8);

                    if (pages.size() > maxPages) {
                        flag("Too many pages (" + pages.size() + ")", "PacketPlayInBEdit");
                        return false;
                    }

                    for (int i = 0; i < pages.size(); i++) {
                        String pageContent = pages.getString(i);

                        if (pageContent.length() > maxPageLength) {
                            flag("Page too long (" + pageContent.length() + ")", "PacketPlayInBEdit");
                            return false;
                        }

                        if (getCharCount(pageContent, '{') > 50 || getCharCount(pageContent, '[') > 50) {
                            flag("Complex JSON detected", "PacketPlayInBEdit");
                            return false;
                        }
                    }
                }
            }
        }
        return true;
    }

    private int getCharCount(String s, char c) {
        int count = 0;
        for (int i = 0; i < s.length(); i++) {
            if (s.charAt(i) == c) count++;
        }
        return count;
    }

    private ItemStack getItemField(Object obj, String name) {
        try {
            Field f = obj.getClass().getDeclaredField(name);
            f.setAccessible(true);
            return (ItemStack) f.get(obj);
        } catch (Exception e) { return null; }
    }
}